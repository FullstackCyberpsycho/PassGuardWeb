<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>PassGuard Web</title>
    <style>
        body{font-family:Arial,sans-serif;max-width:600px;margin:40px auto;background:#f5f5f5}
        .card{background:#fff;padding:20px;border-radius:10px;margin-top:20px;box-shadow:0 2px 6px rgba(0,0,0,0.1)}
        input,button{width:100%;padding:10px;margin:6px 0;border-radius:6px;border:1px solid #ccc;box-sizing:border-box}
        button{border:none;color:#fff;font-size:16px;cursor:pointer;background:#4CAF50}
        button:hover{background:#45a049}
        .hidden{display:none}
        .user-icon{width:40px;height:40px;background:#4CAF50;color:#fff;border-radius:50%;display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:20px;float:right;margin-top:-10px}
        .user-menu{position:absolute;right:20px;top:80px;width:200px;background:#fff;border-radius:10px;box-shadow:0 2px 6px rgba(0,0,0,0.15);padding:15px;display:none}
        .user-menu p{margin:5px 0;font-size:14px}
        .user-menu button{width:100%;margin-top:10px}
        .item{padding:10px;background:#fff;border-radius:6px;border:1px solid #ddd;margin-bottom:8px}
        .edit-btn{background:#2196F3;margin-top:5px}
        .delete-btn{background:#e53935}
    </style>
</head>
<body>
<h2 style="text-align:center;">PassGuard Web</h2>

<div id="userIcon" class="user-icon hidden">U</div>
<div id="userMenu" class="user-menu">
    <p><b>Имя:</b> <span id="menuName"></span></p>
    <p><b>Логин:</b> <span id="menuUsername"></span></p>
    <button onclick="openEditUser()" style="background:#2196F3">Изменить профиль</button>
    <button onclick="logout()" style="background:#e53935">Выйти</button>
</div>

<div id="loginBlock" class="card">
    <h3>Вход</h3>
    <input id="loginUsername" placeholder="Логин">
    <input id="loginPassword" placeholder="Пароль" type="password">
    <button onclick="login()">Войти</button>
</div>

<div id="registerBlock" class="card">
    <h3>Регистрация</h3>
    <input id="regUsername" placeholder="Логин">
    <input id="regName" placeholder="Имя">
    <input id="regPassword" placeholder="Пароль" type="password">
    <button onclick="register()">Зарегистрироваться</button>
</div>

<div id="userPanel" class="card hidden">
    <h3>Личный кабинет</h3>
    <h4>Добавить пароль</h4>
    <input id="serviceName" placeholder="Сервис">
    <input id="website" placeholder="Сайт">
    <input id="username" placeholder="Логин">
    <input id="password" placeholder="Пароль">
    <button onclick="addPass()">Добавить</button>
    <h4>Ваши пароли</h4>
    <button onclick="loadPasswords()" style="background:#2196F3">Обновить список</button>
    <div id="passwordList"></div>
</div>

<div id="editUserPanel" class="card hidden">
    <h3>Редактировать профиль</h3>
    <input id="editUserName" placeholder="Имя">
    <input id="editUserUsername" placeholder="Логин">
    <button onclick="updateUserInfo()">Сохранить</button>
    <button onclick="cancelUserEdit()" style="background:#9e9e9e">Отмена</button>
</div>

<script>
    const API="http://localhost:8080/api";
    const menuName=document.getElementById("menuName");
    const menuUsername=document.getElementById("menuUsername");
    const userIconEl=document.getElementById("userIcon");
    const userMenu=document.getElementById("userMenu");
    const editUserPanel=document.getElementById("editUserPanel");
    const editUserName=document.getElementById("editUserName");
    const editUserUsername=document.getElementById("editUserUsername");

    let editingId=null;

    function showLoginScreen(){
        loginBlock.classList.remove("hidden");
        registerBlock.classList.remove("hidden");
        userPanel.classList.add("hidden");
        editUserPanel.classList.add("hidden");
        userIconEl.classList.add("hidden");
        userMenu.style.display="none";
    }
    function showUserPanel(){
        loginBlock.classList.add("hidden");
        registerBlock.classList.add("hidden");
        userPanel.classList.remove("hidden");
        editUserPanel.classList.add("hidden");
        userIconEl.classList.remove("hidden");
    }
    function toggleMenu(){userMenu.style.display=userMenu.style.display==="block"?"none":"block"}
    userIconEl.addEventListener("click",toggleMenu);

    function openEditUser(){
        editUserPanel.classList.remove("hidden");
        userPanel.classList.add("hidden");
        userMenu.style.display="none";
        editUserName.value=menuName.textContent;
        editUserUsername.value=menuUsername.textContent;
    }
    function cancelUserEdit(){
        editUserPanel.classList.add("hidden");
        userPanel.classList.remove("hidden");
    }

    async function loadUserInfo(){
        const token=localStorage.getItem("token");
        if(!token) return;
        const res=await fetch(`${API}/user/info`,{
            headers:{"Authorization":"Bearer "+token}
        });
        if(!res.ok) return;
        const data=await res.json();
        menuName.textContent=data.name;
        menuUsername.textContent=data.username;
        userIconEl.textContent=data.avatar||(data.name?data.name.charAt(0).toUpperCase():"U");
    }

    async function updateUserInfo(){
        const token=localStorage.getItem("token");
        if(!token) return alert("Нет токена!");
        if(editUserName.value.length<2||editUserUsername.value.length<5){
            return alert("Имя минимум 2 символа, логин минимум 5 символов");
        }
        const body={name:editUserName.value,username:editUserUsername.value,avatar:editUserName.value.charAt(0).toUpperCase()};
        const res=await fetch(`${API}/user/update`,{
            method:"PUT",
            headers:{"Content-Type":"application/json","Authorization":"Bearer "+token},
            body:JSON.stringify(body)
        });
        if(!res.ok){const err=await res.text();console.error(err);return alert("Ошибка обновления: "+err);}
        const data=await res.json();
        menuName.textContent=data.name;
        menuUsername.textContent=data.username;
        userIconEl.textContent=data.avatar;
        editUserPanel.classList.add("hidden");
        userPanel.classList.remove("hidden");
        alert("Профиль обновлён!");
    }

    async function register(){
        const body={username:regUsername.value,name:regName.value,password:regPassword.value};
        const res=await fetch(`${API}/auth/register`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(body)});
        if(res.ok){alert("Регистрация завершена"); await login();}
        else alert("Ошибка регистрации");
    }

    async function login(){
        const body={username:loginUsername.value,password:loginPassword.value};
        const res=await fetch(`${API}/auth/login`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(body)});
        if(!res.ok){alert("Неверный логин или пароль");return;}
        const data=await res.json();
        localStorage.setItem("token",data.token);
        await loadUserInfo();
        showUserPanel();
        loadPasswords();
    }

    function logout(){localStorage.removeItem("token");showLoginScreen();}

    async function addPass(){
        const token=localStorage.getItem("token");
        const body={serviceName:serviceName.value,website:website.value,username:username.value,password:password.value};
        await fetch(`${API}/pass/add-pass`,{method:"POST",headers:{"Content-Type":"application/json","Authorization":"Bearer "+token},body:JSON.stringify(body)});
        loadPasswords();
    }

    async function loadPasswords(){
        const token=localStorage.getItem("token");
        const res=await fetch(`${API}/pass/all-pass`,{method:"GET",headers:{"Authorization":"Bearer "+token}});
        const list=await res.json();
        passwordList.innerHTML="";
        list.forEach(p=>{
            const el=document.createElement("div");
            el.className="item";
            el.innerHTML=`<b>${p.serviceName}</b><br>${p.website}<br>Логин: ${p.username}<br>Пароль: ${p.password}<br>`;
            const editBtn=document.createElement("button");
            editBtn.className="edit-btn"; editBtn.innerText="Изменить"; editBtn.onclick=()=>startEdit(p); el.appendChild(editBtn);
            const delBtn=document.createElement("button");
            delBtn.className="delete-btn"; delBtn.innerText="Удалить"; delBtn.onclick=()=>deletePassword(p.id); el.appendChild(delBtn);
            passwordList.appendChild(el);
        });
    }

    function startEdit(p){
        editingId=p.id;
        editServiceName.value=p.serviceName;
        editWebsite.value=p.website;
        editUsername.value=p.username;
        editPassword.value=p.password;
        editPanel.classList.remove("hidden");
        userPanel.classList.add("hidden");
    }

    async function updatePassword(){
        const token=localStorage.getItem("token");
        const body={serviceName:editServiceName.value,website:editWebsite.value,username:editUsername.value,password:editPassword.value};
        await fetch(`${API}/pass/update-pass/${editingId}`,{method:"PUT",headers:{"Content-Type":"application/json","Authorization":"Bearer "+token},body:JSON.stringify(body)});
        editPanel.classList.add("hidden");
        userPanel.classList.remove("hidden");
        loadPasswords();
    }

    async function deletePassword(id){
        const token=localStorage.getItem("token");
        await fetch(`${API}/pass/delete-pass/${id}`,{method:"DELETE",headers:{"Authorization":"Bearer "+token}});
        loadPasswords();
    }

    showLoginScreen();
</script>
</body>
</html>
