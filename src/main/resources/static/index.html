<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>PassGuard Web</title>

    <style>
        body {
            margin: 0;
            font-family: Inter, sans-serif;
            background: #f2f4f5;
            height: 100vh;
            display: flex;
        }

        /* ===== SIDEBAR ===== */
        .sidebar {
            width: 230px;
            background: #ffffff;
            border-right: 1px solid #dfe3e6;
            padding: 20px;
            display: flex;
            flex-direction: column;
        }
        .avatar {
            width: 64px;
            height: 64px;
            border-radius: 50%;
            background: #1f2937;
            color: white;
            font-size: 26px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 10px auto;
        }
        .username {
            text-align: center;
            margin-bottom: 25px;
            font-weight: 600;
            color: #1f2937;
        }

        .sidebar button {
            padding: 10px;
            border-radius: 8px;
            border: none;
            background: #1f2937;
            color: white;
            margin-bottom: 10px;
            cursor: pointer;
        }
        .sidebar button:hover { background: #111827; }
        .danger { background: #d32f2f !important; }
        .secondary { background: #6b7280 !important; }

        /* ===== MAIN ===== */
        .main {
            flex: 1;
            padding: 25px;
            overflow-y: auto;
        }

        /* верхняя панель */
        .top-bar {
            display: flex;
            justify-content: flex-end;
            margin-bottom: 15px;
        }
        .profile-btn {
            padding: 8px 14px;
            background: #1f2937;
            border-radius: 8px;
            color: white;
            cursor: pointer;
            border: none;
        }
        .profile-btn:hover { background: #111827; }

        input, button {
            padding: 10px;
            border-radius: 8px;
            border: 1px solid #d1d5db;
            font-size: 14px;
        }
        button { cursor: pointer; }

        .item {
            padding: 12px 16px;
            background: #ffffff;
            border-radius: 12px;
            margin-bottom: 12px;
            border: 1px solid #e2e8f0;
        }

        .item-buttons {
            display: flex;
            gap: 8px;
            margin-top: 10px;
        }

        /* MODALS */
        .modal {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.45);
            display: none;
            align-items: center;
            justify-content: center;
        }
        .modal-content {
            background: white;
            padding: 22px;
            width: 340px;
            border-radius: 12px;
        }

        .hidden { display: none !important; }

        /* AUTH */
        .auth-wrapper {
            margin: auto;
            width: 340px;
            background: white;
            padding: 30px;
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }
    </style>
</head>

<body>

<!-- AUTH -->
<div id="authScreen" class="auth-wrapper">
    <h2 style="text-align:center;margin-bottom:20px;">PassGuard Web</h2>

    <h3>Вход</h3>
    <input id="loginUsername" placeholder="Логин"><br><br>
    <input id="loginPassword" type="password" placeholder="Пароль"><br>
    <button onclick="login()">Войти</button>

    <hr style="margin:20px 0;">

    <h3>Регистрация</h3>
    <input id="regUsername" placeholder="Логин"><br><br>
    <input id="regName" placeholder="Имя"><br><br>
    <input id="regPassword" type="password" placeholder="Пароль"><br>
    <button onclick="register()">Создать аккаунт</button>
</div>


<!-- APP -->
<div id="app" class="hidden" style="display:flex; width:100%;">

    <!-- SIDEBAR -->
    <div class="sidebar">
        <div id="avatar" class="avatar">U</div>
        <div id="userNameTitle" class="username">User</div>

        <button onclick="logout()" class="secondary">Выйти</button>
        <button onclick="deleteAccount()" class="danger">Удалить аккаунт</button>
    </div>

    <!-- MAIN -->
    <div class="main">

        <div class="top-bar">
            <button class="profile-btn" onclick="openUserEdit()">Профиль</button>
        </div>

        <h2>Ваши пароли</h2>

        <div style="display:flex; gap:10px; margin-bottom:15px;">
            <input id="searchInput" placeholder="Поиск по сервису" style="flex:1;">
            <button onclick="searchPasswords()">Поиск</button>
        </div>

        <div style="display:flex; gap:10px; margin-bottom:15px;">
            <button onclick="sortAsc()">A→Z</button>
            <button onclick="sortDesc()" class="secondary">Z→A</button>
        </div>

        <h3>Добавить пароль</h3>
        <div style="display:flex; gap:10px; flex-wrap:wrap;">
            <input id="serviceName" placeholder="Сервис" style="flex:1;">
            <input id="website" placeholder="Сайт" style="flex:1;">
            <input id="username" placeholder="Логин" style="flex:1;">
            <input id="password" placeholder="Пароль" style="flex:1;">
            <button onclick="addPass()">Добавить</button>
        </div>

        <h3 style="margin-top:20px;">Список</h3>
        <button onclick="loadPasswords()">Обновить</button>

        <div id="passwordList" style="margin-top:20px;"></div>
    </div>
</div>


<!-- MODAL: edit password -->
<div id="editModal" class="modal">
    <div class="modal-content">
        <h3>Редактировать</h3>
        <input id="editServiceName" placeholder="Сервис"><br><br>
        <input id="editWebsite" placeholder="Сайт"><br><br>
        <input id="editUsername" placeholder="Логин"><br><br>
        <input id="editPassword" placeholder="Пароль"><br><br>

        <button onclick="updatePassword()">Сохранить</button>
        <button onclick="closeEditModal()" class="secondary">Отмена</button>
    </div>
</div>

<!-- MODAL: edit user -->
<div id="userModal" class="modal">
    <div class="modal-content">
        <h3>Редактировать профиль</h3>
        <input id="editUserName" placeholder="Имя"><br><br>
        <input id="editUserUsername" placeholder="Логин"><br><br>

        <button onclick="saveUserEdit()">Сохранить</button>
        <button onclick="closeUserModal()" class="secondary">Отмена</button>
    </div>
</div>

<script>
    const API = "http://localhost:8080/api";
    let editingId = null;
    let CURRENT_USER = null;

    /* ================= AUTH ================= */
    async function login() {
        const res = await fetch(`${API}/auth/login`, {
            method: "POST",
            headers: {"Content-Type": "application/json"},
            body: JSON.stringify({
                username: loginUsername.value,
                password: loginPassword.value
            })
        });

        if (!res.ok) return alert("Ошибка");

        const data = await res.json();
        localStorage.setItem("token", data.token);

        authScreen.classList.add("hidden");
        app.classList.remove("hidden");

        loadUserInfo();
        loadPasswords();
    }

    async function register() {
        const res = await fetch(`${API}/auth/register`, {
            method: "POST",
            headers: {"Content-Type": "application/json"},
            body: JSON.stringify({
                username: regUsername.value,
                name: regName.value,
                password: regPassword.value
            })
        });

        if (!res.ok) return alert("Ошибка регистрации");

        alert("Регистрация успешна!");
    }


    /* ================= USER ================= */
    async function loadUserInfo() {
        const token = localStorage.getItem("token");

        const res = await fetch(`${API}/user/info`, {
            headers: {Authorization: "Bearer " + token}
        });

        CURRENT_USER = await res.json();

        userNameTitle.textContent = CURRENT_USER.name;
        avatar.textContent = CURRENT_USER.name[0].toUpperCase();
    }

    function openUserEdit() {
        editUserName.value = CURRENT_USER.name;
        editUserUsername.value = CURRENT_USER.username;
        userModal.style.display = "flex";
    }

    function closeUserModal() {
        userModal.style.display = "none";
    }

    async function saveUserEdit() {
        const token = localStorage.getItem("token");

        await fetch(`${API}/user/update`, {
            method: "PUT",
            headers: {
                "Content-Type": "application/json",
                Authorization: "Bearer " + token
            },
            body: JSON.stringify({
                name: editUserName.value,
                username: editUserUsername.value
            })
        });

        closeUserModal();
        loadUserInfo();
    }

    function logout() {
        localStorage.removeItem("token");
        location.reload();
    }


    /* ================= PASSWORDS ================= */
    function render(list) {
        passwordList.innerHTML = "";

        list.forEach(p => {
            const box = document.createElement("div");
            box.className = "item";

            const link = p.website && p.website.startsWith("http")
                ? `<a href="${p.website}" target="_blank">${p.website}</a>`
                : p.website;

            box.innerHTML = `
                <b>${p.serviceName}</b><br>
                ${link || ""}<br>
                <small>Логин: ${p.username}</small><br>
                <small>Пароль: ${p.password}</small>
            `;

            const btns = document.createElement("div");
            btns.className = "item-buttons";

            const editBtn = document.createElement("button");
            editBtn.textContent = "Изменить";
            editBtn.onclick = () => openEdit(p);

            const delBtn = document.createElement("button");
            delBtn.textContent = "Удалить";
            delBtn.className = "danger";
            delBtn.onclick = () => deletePassword(p.id);

            btns.appendChild(editBtn);
            btns.appendChild(delBtn);

            box.appendChild(btns);
            passwordList.appendChild(box);
        });
    }

    async function loadPasswords() {
        const res = await fetch(`${API}/pass/all-pass`, {
            headers: {Authorization: "Bearer " + localStorage.getItem("token")}
        });

        render(await res.json());
    }

    async function addPass() {
        await fetch(`${API}/pass/add-pass`, {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                Authorization: "Bearer " + localStorage.getItem("token")
            },
            body: JSON.stringify({
                serviceName: serviceName.value,
                website: website.value,
                username: username.value,
                password: password.value
            })
        });

        loadPasswords();
    }

    function openEdit(p) {
        editingId = p.id;
        editServiceName.value = p.serviceName;
        editWebsite.value = p.website;
        editUsername.value = p.username;
        editPassword.value = p.password;

        editModal.style.display = "flex";
    }

    function closeEditModal() {
        editModal.style.display = "none";
    }

    async function updatePassword() {
        await fetch(`${API}/pass/update-pass/${editingId}`, {
            method: "PUT",
            headers: {
                "Content-Type": "application/json",
                Authorization: "Bearer " + localStorage.getItem("token")
            },
            body: JSON.stringify({
                serviceName: editServiceName.value,
                website: editWebsite.value,
                username: editUsername.value,
                password: editPassword.value
            })
        });

        closeEditModal();
        loadPasswords();
    }

    async function deletePassword(id) {
        await fetch(`${API}/pass/delete-pass/${id}`, {
            method: "DELETE",
            headers: {Authorization: "Bearer " + localStorage.getItem("token")}
        });

        loadPasswords();
    }

    async function searchPasswords() {
        const q = searchInput.value.trim();
        if (!q) return;

        const res = await fetch(`${API}/pass/search?serviceName=` + q, {
            headers: {Authorization: "Bearer " + localStorage.getItem("token")}
        });

        render(await res.json());
    }

    async function sortAsc() {
        const res = await fetch(`${API}/pass/sorted-serviceName-asc`, {
            headers: {Authorization: "Bearer " + localStorage.getItem("token")}
        });
        render(await res.json());
    }

    async function sortDesc() {
        const res = await fetch(`${API}/pass/sorted-serviceName-desc`, {
            headers: {Authorization: "Bearer " + localStorage.getItem("token")}
        });
        render(await res.json());
    }
</script>

</body>
</html>
